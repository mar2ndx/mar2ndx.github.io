<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">





<title>[NineChap System Design] Class 4.1: Crawler  | Tech blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 7.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const pagebody = document.getElementsByTagName('body')[0]

            function setTheme(status) {

                if (status === 'dark') {
                    window.sessionStorage.theme = 'dark'
                    pagebody.classList.add('dark-theme');

                } else if (status === 'light') {
                    window.sessionStorage.theme = 'light'
                    pagebody.classList.remove('dark-theme');
                }
            };

            setTheme(window.sessionStorage.theme)
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Bentham&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                <a class="menu-item" href="/archives">Posts</a>
                
                <a class="menu-item" href="/category">Categories</a>
                
                <a class="menu-item" href="/tag">Tags</a>
                
                <a class="menu-item" href="/about">About</a>
                
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Bentham&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">
                    <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M4.5 17.27q-.213 0-.356-.145T4 16.768t.144-.356t.356-.143h15q.213 0 .356.144q.144.144.144.357t-.144.356t-.356.143zm0-4.77q-.213 0-.356-.144T4 11.999t.144-.356t.356-.143h15q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-4.77q-.213 0-.356-.143Q4 7.443 4 7.23t.144-.356t.356-.143h15q.213 0 .356.144T20 7.23t-.144.356t-.356.144z"/></svg>
                    <svg class="close-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Material Symbols Light by Google - https://github.com/google/material-design-icons/blob/master/LICENSE --><path fill="currentColor" d="m12 12.708l-5.246 5.246q-.14.14-.344.15t-.364-.15t-.16-.354t.16-.354L11.292 12L6.046 6.754q-.14-.14-.15-.344t.15-.364t.354-.16t.354.16L12 11.292l5.246-5.246q.14-.14.345-.15q.203-.01.363.15t.16.354t-.16.354L12.708 12l5.246 5.246q.14.14.15.345q.01.203-.15.363t-.354.16t-.354-.16z"/></svg>
                </div>
            </div>
            <div class="menu" id="mobile-menu">
                
                <a class="menu-item" href="/archives">Posts</a>
                
                <a class="menu-item" href="/category">Categories</a>
                
                <a class="menu-item" href="/tag">Tags</a>
                
                <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.classList.contains("active")) {
            toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        } else {
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">[NineChap System Design] Class 4.1: Crawler </h1>
            
                <div class="post-meta">
                    

                    
                        <span class="post-time">
                        Date: <a href="#">August 30, 2015&nbsp;&nbsp;0:00:00</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/NineChap/">NineChap</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p><strong>KISS - Keep It Simple, Sweetie</strong>.</p>
<p>In Today’s lecture:</p>
<ol>
<li>write a crawler</li>
<li>thread-saft consumer &amp; producer</li>
<li>GFS, BigTable and MapReduce</li>
<li>Top 10 keyword&#x2F;anagram using MapReduce</li>
<li>Log analysis</li>
</ol>
<h1 id="News-Aggregator-App"><a href="#News-Aggregator-App" class="headerlink" title="News Aggregator App"></a>News Aggregator App</h1><ol>
<li><p>Info Collection</p>
<p>crawler</p>
</li>
<li><p>Info retrieval: rank, search and recommend.</p>
<p>They are in fact, all related to <strong>sorting</strong>.</p>
</li>
</ol>
<p><img src="/images/design-class4-News-Aggregator.png"></p>
<h2 id="Step-1-Info-collection-with-crawler"><a href="#Step-1-Info-collection-with-crawler" class="headerlink" title="Step 1, Info collection with crawler"></a>Step 1, Info collection with crawler</h2><h3 id="crawler-code"><a href="#crawler-code" class="headerlink" title="crawler code"></a>crawler code</h3><p>Python:</p>
<pre><code>import urllib2

# request
url = &quot;www.google.com&quot;
request = urllib2.Request(url)
response = urllib2.urlopen(request)
page = response.read()

# save the file
webFile = open(&#39;webpage.html&#39;, &#39;web&#39;)
webFile.write(page)
webFile.close()
</code></pre>
<h3 id="Network-process"><a href="#Network-process" class="headerlink" title="Network process"></a>Network process</h3><p>Use of <strong>socket</strong>.</p>
<p><img src="/images/design-class4-web-socket-1.png"></p>
<p>Socket is like the cellphone in the Call Center example.</p>
<blockquote>
<p><strong><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Network_socket">socket</a></strong> is an endpoint of an inter-process communication across a computer network.</p>
</blockquote>
<blockquote>
<p>Today, most communication between computers is based on the Internet Protocol; therefore most network sockets are <strong>Internet sockets</strong>.</p>
</blockquote>
<p>What is socket? Where is it?</p>
<p><img src="/images/design-class4-web-socket-2.png"></p>
<p>It’s in-between <strong>Application Layer</strong> (HTTP, FTP, DNS) and <strong>Transport layer</strong> (UDP, TCP).</p>
<p>Remembering that socket is like a cellphone. It is an <strong>abstraction layer</strong>, that hinds the complexity of lower layer, thus making it easier to sende data in application layer.</p>
<h3 id="How-is-client-connected-to-Server"><a href="#How-is-client-connected-to-Server" class="headerlink" title="How is client connected to Server?"></a>How is client connected to Server?</h3><p>3-way handshake. Read <strong>[Design] TCP 3-Way Handshake</strong></p>
<h3 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h3><p><a target="_blank" rel="noopener" href="http://www.w3schools.com/js/js_htmldom.asp">DOM tree</a>:</p>
<p><img src="/images/html-dom-tree.gif"></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://www.w3.org/TR/DOM-Level-2-Core/introduction.html">Document Object Model</a> (DOM) is an application programming interface (API) for valid HTML and well-formed XML documents. It <strong>defines the logical structure of documents</strong> and the way a document is accessed and manipulated.</p>
</blockquote>
<h3 id="How-to-crawler-all-the-news"><a href="#How-to-crawler-all-the-news" class="headerlink" title="How to crawler all the news"></a>How to crawler all the news</h3><ol>
<li>Go to index page</li>
<li>identify all the links (regex)</li>
</ol>
<h2 id="Crawl-more-websites"><a href="#Crawl-more-websites" class="headerlink" title="Crawl more websites"></a>Crawl more websites</h2><h3 id="Simple-design"><a href="#Simple-design" class="headerlink" title="Simple design"></a>Simple design</h3><ol>
<li>use crawlers to find out all list pages</li>
<li>send the new lists to a Scheduler</li>
<li>Scheduler will use crawlers again, to crawl pages.</li>
</ol>
<p><img src="/images/design-class4-cralwer-arch-1.png"></p>
<p>This design is bad, cuz there is crawler waste. How can we <strong>reuse</strong> these crawlers???</p>
<h3 id="Adv-design"><a href="#Adv-design" class="headerlink" title="Adv design"></a>Adv design</h3><p>Design crawler that can crawl <strong>both list and pages</strong> information.</p>
<blockquote>
<p>Look at our crawler: the text extraction logic and Regex for <em>abc.com</em> and <em>bfe.com</em> are totally different. However, they both share the same crawling techniques.</p>
</blockquote>
<p>So we pass in all info a crawler task needs. Like:</p>
<p><img src="/images/design-class4-cralwer-arch-2.png"></p>
<ol>
<li><p>we gave <strong>more priority to list pages than content pages</strong>. Otherwise, your content get out of date soon.</p>
</li>
<li><p>Type include both list&#x2F;content and source info.</p>
</li>
<li><p>status can be done, working, or new.</p>
</li>
<li><p>timestamps helps us make sure each crawler runs every hour (let’s say)</p>
</li>
</ol>
<p>So when schedule <strong>pick the next crawler task</strong> to run, it will choose <strong>based on Priority</strong>. However if the <strong>timestamp (availableTime) is not yet reached</strong>, the job won’t be executed.</p>
<p>If you crawler <strong>runs until endTime</strong> and haven’t finish, force finish it. We should also add <strong>task created time</strong> to the info.</p>
<h3 id="How-to-identify-similar-news"><a href="#How-to-identify-similar-news" class="headerlink" title="How to identify similar news?"></a>How to identify similar news?</h3><p>Calculate the similarity between pages. More on this subject later.</p>
<h2 id="How-to-design-Scheduler"><a href="#How-to-design-Scheduler" class="headerlink" title="How to design Scheduler?"></a>How to design Scheduler?</h2><p><img src="/images/design-class4-cralwer-arch-3.png"></p>
<h3 id="Solution-with-Sleep"><a href="#Solution-with-Sleep" class="headerlink" title="Solution with Sleep"></a>Solution with Sleep</h3><p>Define variables:</p>
<pre><code>taskTable&lt;table&gt; - store task lists
pageTable&lt;page&gt; - store page contents

task.url
task.state = new/working/done
task.type = list/page
</code></pre>
<p>code:</p>
<pre><code>while (true) &#123;
    // get 1 task. If can&#39;t get, wait
    taskTable.lock();               // IMPORTANT
    newTask = taskTable.findOne(state == &#39;new&#39;)

    if (!newTask) &#123;
        taskTable.unlock();         // IMPORTANT
        sleep(1000);                // IMPORTANT
        continue;
    &#125;

    newTask.state = &quot;working&quot;;
    taskTable.unlock();

    // execute the task, and insert to
    // either taskTable or pageTable
    newPage = Crawl(newTask.url);

    if (newTask.state === &#39;list&#39;) &#123;
        // insert all urls to taskTable
        taskTable.lock();
        foreach (url in newPage) &#123;
            taskTable.add(new task(url));
        &#125;

        // mark the task as &quot;done&quot;
        newTask.state = &quot;done&quot;;     // IMPORTANT
        taskTable.unlock();
    &#125; else &#123;
        // insert page content to pageTable
        pageTable.lock();
        pageTable.add(newPage.content());
        pageTable.unlock();

        // mark the task as &quot;done&quot;
        taskTable.lock();
        newTask.state = &quot;done&quot;;     // IMPORTANT
        taskTable.unlock();
    &#125;
&#125;
</code></pre>
<h3 id="Solution-with-Conditional-Variable"><a href="#Solution-with-Conditional-Variable" class="headerlink" title="Solution with Conditional Variable"></a>Solution with Conditional Variable</h3><p>What is Conditional Variable:</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://goo.gl/xOFXrY">A condition variable</a> is basically <strong>a container of threads that are waiting on a certain condition</strong>.</p>
<p>Monitors provide a mechanism for threads to temporarily give up exclusive access in order to wait for some condition to be met, before regaining exclusive access and resuming their task.</p>
</blockquote>
<p><img src="/images/design-class4-condition-variable.png"></p>
<p>Look at last 3 lines of code. <strong>Before going to sleep, CV have to release the lock</strong>, so that other threads can access the taskTable.</p>
<p>Then CV goes to sleep. <strong>Right after CV has been waken up</strong>, it has to lock the mutex again.</p>
<p>Solution w&#x2F; cv:</p>
<pre><code>while (true) &#123;
    // get 1 task. If can&#39;t get, wait
    taskTable.lock();
    newTask = taskTable.findOne(state == &#39;new&#39;)

    if (!newTask) &#123;
        taskTable.unlock();
        Cond_Wait(cond, taskTable);  // Modified
        continue;
    &#125;

    newTask.state = &quot;working&quot;;
    taskTable.unlock();

    // execute the task, and insert to
    // either taskTable or pageTable
    newPage = Crawl(newTask.url);

    if (newTask.state === &#39;list&#39;) &#123;
        // insert all urls to taskTable
        taskTable.lock();
        foreach (url in newPage) &#123;
            taskTable.add(new task(url));
            Cond_Signal(cond);       // Modified
        &#125;

        // mark the task as &quot;done&quot;
        newTask.state = &quot;done&quot;;
        taskTable.unlock();
    &#125; else &#123;
        // insert page content to pageTable
        pageTable.lock();
        pageTable.add(newPage.content());
        pageTable.unlock();

        // mark the task as &quot;done&quot;
        taskTable.lock();
        newTask.state = &quot;done&quot;;
        taskTable.unlock();
    &#125;
&#125;
</code></pre>
<p>Why Good: no need to busy-spin (example above have to always wait 1 second). So this solution is better.</p>
<h3 id="Solution-with-Semaphore"><a href="#Solution-with-Semaphore" class="headerlink" title="Solution with Semaphore"></a>Solution with Semaphore</h3><p>This is better than Condition Variable, cuz it’s easier to implement. And Semaphore not only locks thread, it also <strong>can lock process</strong>.</p>
<p>CV locks on a certain condition. But Semaphore locks the numbers (of task, or resources etc).</p>
<p>Semaphore implementation (fairly difficult, read for interest):</p>
<pre><code>Wait(semaphore) &#123;
    Lockf(semaphore);
    semaphore.value--;
    if (semaphore.value &lt; 0) &#123;
        semaphore.processWaitList.Add(this.process);
        Release(semaphore);
        Block(this.process);
    &#125; else &#123;
        Release(semaphore);
    &#125;
&#125;

Signal(semaphore) &#123;
    Lock(semaphore);
    semaphore.value++;
    if (semaphore.value &lt;= 0) &#123;
        process = semaphore.processWaitList.pop();
        Wakeup(process);
    &#125;
    Release(semaphore);
&#125;
</code></pre>
<p>Note that in Java and C++, Wait() &#x3D;&#x3D; acquire() and Signal() &#x3D;&#x3D; release(). Read more <a target="_blank" rel="noopener" href="http://tutorials.jenkov.com/java-util-concurrent/semaphore.html">Jenkov’s post</a>.</p>
<p>code w&#x2F; semaphore:</p>
<pre><code>while (true) &#123;
    // get 1 task. If can&#39;t get, wait
    Wait(numberOfNewTask);           // Modified

    taskTable.lock();
    newTask = taskTable.findOne(state == &#39;new&#39;)
    newTask.state = &quot;working&quot;;
    taskTable.unlock();

    // execute the task, and insert to
    // either taskTable or pageTable
    newPage = Crawl(newTask.url);

    if (newTask.state === &#39;list&#39;) &#123;
        // insert all urls to taskTable
        taskTable.lock();
        foreach (url in newPage) &#123;
            taskTable.add(new task(url));
            Signal(numberOfNewTask); // Modified
        &#125;

        // mark the task as &quot;done&quot;
        newTask.state = &quot;done&quot;;
        taskTable.unlock();
    &#125; else &#123;
        // insert page content to pageTable
        pageTable.lock();
        pageTable.add(newPage.content());
        pageTable.unlock();

        // mark the task as &quot;done&quot;
        taskTable.lock();
        newTask.state = &quot;done&quot;;
        taskTable.unlock();
    &#125;
&#125;
</code></pre>
<p><strong>What happens in Line 3 ‘Wait(numberOfNewTask)’</strong>? Well, the programs checks on the numberOfNewTask (counter) variable, and:</p>
<ol>
<li>If there is 1 or more tasks, just proceed.</li>
<li>If no tasks available, block itself and wait there. (Later someone will wake it up and it will resume).</li>
</ol>
<h3 id="Design-an-consumer-producer"><a href="#Design-an-consumer-producer" class="headerlink" title="Design an consumer-producer"></a>Design an consumer-producer</h3><p>Stay tuned for future post.</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://mar2ndx.github.io/2015/08/30/pre-2017-2015-08-30-design-class4-1/">https://mar2ndx.github.io/2015/08/30/pre-2017-2015-08-30-design-class4-1/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2015/09/02/pre-2017-2015-09-02-Facebook-photo-storage/">[Design] Facebook Photo Storage </a>
            
            
            <a class="next" rel="next" href="/2015/08/30/pre-2017-2015-08-30-design-class4-2/">[NineChap System Design] Class 4.2: Search Engine </a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>©  | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>