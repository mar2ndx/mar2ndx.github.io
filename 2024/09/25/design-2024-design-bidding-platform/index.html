<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
  <title>
    
    System Design 2024 - Bidding Platform 丨
    

    typo
  </title>

  
  <link rel="shortcut icon" href="/icon.svg">
  

  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  
  <link id="theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.css">
  <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  

  <!-- 字体 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">

  
<link rel="stylesheet" href="/css/root.css">

  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/post.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <header class="header">
  <section class="header-container">
    <a class="logo" href="/">Tech blog</a>
    <ul class="nav">
      
      <li><a href="/archives">archives</a></li>
      
      <li><a href="/about">about</a></li>
      
    </ul>
  </section>
</header>
  <main class="main">
    <article class="post">
  
  <div class="post-title">System Design 2024 - Bidding Platform</div>
  <div class="post-meta">
    <div class="date">2024 September 25th</div>
    <div class="tags">
      
    </div>
  </div>
  

  <main class="post-content"><h1 id="Design-Bidding-Platform"><a href="#Design-Bidding-Platform" class="headerlink" title="Design Bidding Platform"></a>Design Bidding Platform</h1><h1 id="1-Requirements"><a href="#1-Requirements" class="headerlink" title="1. Requirements"></a>1. Requirements</h1><ol>
<li>A user can bid on an item.</li>
<li>Fix-time bidding &amp; Variable-time bidding.</li>
<li>Real-time price update.</li>
<li>Support 100+ QPS for each item.</li>
</ol>
<h1 id="2-Data-Model"><a href="#2-Data-Model" class="headerlink" title="2. Data Model"></a>2. Data Model</h1><ol>
<li><p>Bid表</p>
<p>bidID, auctionID, userID, price, serverside_timestamp, status. </p>
<p><strong>status</strong> could be Accepted&#x2F;Rejected. </p>
<p>Put this into a <strong>time-series database</strong> by autionID, because eventually we need all bids per auction for auditing purposes. </p>
</li>
<li><p>AuctionState表</p>
<p>autionID, currentWinningBidID, price, end_auction_timestamp.</p>
<p>This is only 32 bytes, thus entire storage is &lt; 32GB, can use in-memory DB.</p>
</li>
</ol>
<h1 id="3-Bidding-Core"><a href="#3-Bidding-Core" class="headerlink" title="3. Bidding Core"></a>3. Bidding Core</h1><ul>
<li>This system is similar to the Robinhood (Stock Exchange) Design. </li>
<li>Need a single point of “choke-point”. A multi-leader or leaderless model won’t work here.</li>
</ul>
<h2 id="Option-1-bid-with-Kafka"><a href="#Option-1-bid-with-Kafka" class="headerlink" title="Option 1: bid with Kafka"></a>Option 1: bid with Kafka</h2><p>Use Kafka as log-based message broker. </p>
<p>Order by log. </p>
<p>Kafka uses Kernel bypass to achieve high write throughput. </p>
<p><img src="/images/system-design-bidding-platform-1.jpg"></p>
<p>Downside: use will be notified about bidding result, async. Thus using Kafka is not a great solution. </p>
<h2 id="Option-2-synchronized-bid"><a href="#Option-2-synchronized-bid" class="headerlink" title="Option 2: synchronized-bid"></a>Option 2: synchronized-bid</h2><p>Bid Engine: single choke point. </p>
<p>It must handle high throughput. </p>
<p>State-machine replication, similar to the exchange. </p>
<p>Solution: </p>
<ol>
<li>In-memory.</li>
<li>No disk read or network calls. </li>
<li>For each request, lock the auction state, compare bids, and proceed. </li>
<li>We can partition Bid Engine by auctionID using consistant hashing. </li>
<li>But make sure all bids for 1 auction always on the same machine.</li>
</ol>
<p><img src="/images/system-design-bidding-platform-2.jpg"></p>
<h3 id="How-to-achieve-fault-tolerance"><a href="#How-to-achieve-fault-tolerance" class="headerlink" title="How to achieve fault tolerance?"></a>How to achieve fault tolerance?</h3><p>Need a backup, that only listens to master. </p>
<p>Each bid has a seq number. </p>
<h1 id="4-Message-delivery"><a href="#4-Message-delivery" class="headerlink" title="4. Message delivery"></a>4. Message delivery</h1><p>Multiple clients want to know the bidding results, namely: </p>
<ol>
<li>Backup bidding engine</li>
<li>Audit database</li>
<li>Other users</li>
</ol>
<p>Let’s put in Kafka <strong>so multiple consumers can subscribe</strong>! </p>
<p>Remember your Kafka is the source of truth, with certain replication configurations. </p>
<p><img src="/images/system-design-bidding-platform-3.jpg"></p>
<p>Note: </p>
<ol>
<li>Publish to Kafka first, then notify user. </li>
<li>However, it’s possible that bid is lost if Kafka goes down, so maybe publish to 2 brokers instead of 1.</li>
</ol>
<h2 id="How-to-keep-Bid-Engine-thoughput-high"><a href="#How-to-keep-Bid-Engine-thoughput-high" class="headerlink" title="How to keep Bid Engine thoughput high?"></a>How to keep Bid Engine thoughput high?</h2><p>Remember now we have additional network call to Kafka, and we need sychronous return to cleint about the bid result. </p>
<p>Here’s the psueducode. </p>
<p><img src="/images/system-design-bidding-platform-4.jpg"></p>
<p>But to solve the problem of Kafka race condition: </p>
<p><img src="/images/system-design-bidding-platform-5.jpg"></p>
<p>这一段没太看懂！</p>
<h1 id="5-Bid-consumers"><a href="#5-Bid-consumers" class="headerlink" title="5. Bid consumers"></a>5. Bid consumers</h1><p><img src="/images/system-design-bidding-platform-6.jpg"></p>
<h1 id="6-Popular-auctions"><a href="#6-Popular-auctions" class="headerlink" title="6. Popular auctions"></a>6. Popular auctions</h1><p>Many people watching the top Kafka queue. like this:</p>
<p><img src="/images/system-design-bidding-platform-7.jpg"></p>
<h1 id="7-Auction-ending"><a href="#7-Auction-ending" class="headerlink" title="7. Auction ending"></a>7. Auction ending</h1><ol>
<li>As bid come in, update the finish time. </li>
<li>Bid engine occasionally check the auction time.</li>
</ol>
<p><img src="/images/system-design-bidding-platform-8.jpg"></p>
<p>Reference：<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=3aX-lC5_P1M">https://www.youtube.com/watch?v=3aX-lC5_P1M</a></p>
</main>

</article>


<script src="/js/highlight.js"></script>

  </main>
  <footer class="footer">
  
  <span>Copyright © 2024 typo</span>
  
</footer>
  
<script src="/js/theme.js"></script>

</body>

</html>